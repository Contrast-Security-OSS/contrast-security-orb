description: >
  Download the Contrast Security agent. Requirements: curl, base64

parameters:
  username:
    type: env_var_name
    default: CONTRAST_USERNAME
    description: >
      Name of environment variable storing your Contrast username

  service-key:
    type: env_var_name
    default: CONTRAST_SERVICE_KEY
    description: >
      Name of environment variable storing your Contrast service key

  team-server-url:
    type: env_var_name
    default: CONTRAST_TEAM_SERVER_URL
    description: >
      Name of environment variable storing the URL of your Contrast
      team server

  org-id:
    type: env_var_name
    default: CONTRAST_ORG_ID
    description: >
      Name of environment variable storing your Contrast organization ID

  api-key:
    type: env_var_name
    default: CONTRAST_API_KEY
    description: >
      Name of environment variable storing your Contrast API key

steps:
  - run:
      name: Download Contrast agent
      command: |
        #Download node-contrast.tgz in the workspace and set the instrumentation.
        #
        #Do not change below
        #

        authorization="$<<parameters.username>>:$<<parameters.service-key>>"

        authorization=`echo $authorization |tr -d \\\n |base64`

        curl --max-time 30 \
          "$<<parameters.team-server-url>>/api/ng/<<parameters.org-id>>/agents/external/default/node" \
          -H Accept:text/yaml \
          -H "API-Key:$<<parameters.api-key>>" \
          -H "Authorization:$authorization" \
          -o contrast_security.yaml

        curl --max-time 30 \
          "$<<parameters.team-server-url>>/api/ng/<<parameters.org-id>>/agents/default/node \
          -H "API-Key:<<parameters.api-key>>" \
          -H "Authorization:$authorization" \
          -o node-contrast.tgz

        actualsize=$(wc -c <"node-contrast.tgz")

        if [ $actualsize -ge 2000000 ]; then
           echo [Contrast] Node-contrast.tgz downloaded Successfully in the Workspace
        else
           echo [Contrast] Node-contrast.tgz not downloaded successfully, check orb parameter values
           exit 1
        fi
